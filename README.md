# reportMangoTelecom
Данный скрипт дает возможность получения информации о том, был ли совершен успешный звонок с клиентов в телефонии Mango Office

Это продолжение логики [callback](https://github.com/thnik911/callbackMangoTelecom). Скрипт автоматически запускается из Бизнес процесса через 15 минут после запуска callback. Результатом выполнения скрипта является получение информации из Mango Office о том, была ли успешная коммуникация с клиентом.

**Механизм работы**:

1. Через 15 минут после того, как callback был запущен, запускается reportMango.php посредством вебхука. В вебхук приходит 2 параметра дат: дата начала - текущая дата / время минус 15 минут, вторая - текущее дата и время. Также в POST запросе содержится ID сделки и телефон.
2. После того, как запрос в Манго отправлен, на стороне АТС идет формирование отчета. Результатом выполнения является ключ, полученный на основании запроса /vpbx/stats/request
3. После того, как ключ получен, по нему выгрузить отчет в csv с помощью метода /vpbx/stats/result.
4. Если скрипт не нашел успешных звоноков на стороне Mango Ofiice, то логика callback перезапускается.
5. Если скрипт нашел успешные звонки, то происходит изменение сделки.

Решение может работать как на облачных, так и коробочных Битрикс24. 

**Как запустить**:
1. reportMango.php и auth.php необходимо разместить на хостинге с поддержкой SSL.
2. В разделе "Разработчикам" необходимо создать входящий вебхук с правами на CRM (crm). Подробнее как создать входящий / исходящий вебхук: [Ссылки на документацию 1С-Битрикс и Mango Office](https://github.com/thnik911/callbackMangoTelecom/blob/main/README.md#%D1%81%D1%81%D1%8B%D0%BB%D0%BA%D0%B8-%D0%BD%D0%B0-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D1%8E-1%D1%81-%D0%B1%D0%B8%D1%82%D1%80%D0%B8%D0%BA%D1%81-%D0%B8-mango-office).
3. Полученный "Вебхук для вызова rest api" прописать в auth.php.
4. В строке 24 и 25 необходимо указать Уникальный ключ Вашей АТС и Ключ для создания подписи. Где найти ключи: [Ссылки на документацию 1С-Битрикс и Mango Office](https://github.com/thnik911/callbackMangoTelecom/blob/main/README.md#%D1%81%D1%81%D1%8B%D0%BB%D0%BA%D0%B8-%D0%BD%D0%B0-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D1%8E-1%D1%81-%D0%B1%D0%B8%D1%82%D1%80%D0%B8%D0%BA%D1%81-%D0%B8-mango-office)
5. В строке 123 необходимо изменить 'TEMPLATE_ID' на тот процесс, где у расположен вебхук по запуску callback.
6. В строке 141 необходимо указать код этапа ('STAGE_ID'), на который необходимо переместить сделку (если требуется).
7. В строке 142 необходимо указать код поля (поле с типом дата и время ['UF_CRM_1677488494']), в которое нужно записать дату и время успешной коммуникации
6. Делаем POST запрос посредством конструкции Webhook* через робот, или бизнес-процессом: https://yourdomain.com/path/reportMango.php?deal=123&phone=79001234567&dateFrom=03.03.2023 10:00:00&dateTo=03.03.2023 10:15:00

Переменные передаваемые в POST запросе:

yourdomain.com - адрес сайта, на котором размещены скрипты auth.php и invioceAdd.php с поддержкой SSL.

path - путь до скрипта.

deal - ID сделки.

phone - Телефон, который хранится в карточке контакта

dateFrom - дата и время начала интервала поиска звонка

dateTo - дата и время окончания интервала поиска звонка

### Ссылки на документацию 1С-Битрикс и Mango Office

<details><summary>Развернуть список</summary>

1. Действие Webhook внутри Бизнес-процесса / робота https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=57&LESSON_ID=8551
2. Как создать Webhook https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=99&LESSON_ID=8581&LESSON_PATH=8771.8583.8581
3. Документация по работе API Mango Office: https://www.mango-office.ru/upload/medialibrary/68c/MangoOffice_VPBX_API_v1.9.pdf
</details>
